var autosave={config:{action:{},pointer:{},success:{},fail:{},before:{}},load:function(a,t){var e=(a=$(a)).prop("tagName").toLowerCase(),o="";if((o=a.attr("form"==e?"action":"data-action"))&&""!=o)if(t.action=o,0==a.children().length){if(e=a.prop("tagName").toLowerCase(),autosave.valid(a,e)){a.attr("data-action");var n,r=t;r.pointer=a,r.action=o,n=(r=autosave.getConfig(r)).pointer,void 0==a.attr("data-cache")&&(autosave.config.pointer[n].child.push(a),autosave.create({target:a,config:r,tag:e}))}}else a.find("*").each(function(){var e=$(this),n=e.prop("tagName").toLowerCase();if(autosave.valid(e,n)){var r,i=e.attr("data-action"),c=t;c.pointer=a,c.action=void 0==i?o:i,r=(c=autosave.getConfig(c)).pointer,void 0==e.attr("data-cache")&&(autosave.config.pointer[r].child.push(e),autosave.create({target:e,config:c,tag:n}))}})},create:function(a){var t=a.target,e=a.tag,o=a.config,n=autosave.getInfo(t,e),r=void 0==t.attr("name")?t.attr("data-name"):t.attr("name");o.value=n.value,o.name=r,o=JSON.stringify(o),t.attr("data-cache",o),t.on(n.event,function(a){var t=$(this),e=JSON.parse(t.attr("data-cache"));autosave.save(t,e)})},getInfo:function(a,t){var e=a.attr("type"),o={};return"checkbox"==e||"radio"==e?(o.value=a.is(":checked"),o.event="change"):"input"==t||"textarea"==t?(o.value=a.val(),o.event="blur"):"select"==t?(o.value=a.val(),o.event="change"):(o.value=a.html(),o.event="blur"),o},getConfig:function(a){for(var t=["pointer","before","success","fail","action"],e={},o=0;o<t.length;o++){var n=t[o];autosave.isExist(a[n])&&(e[n]=autosave.getToken(n,a[n]))}return e},getToken:function(a,t){var e="pointer"==a?autosave.config[a].parent:autosave.config[a];for(var o in autosave.config[a]){if(autosave.config[a][o]==t)return o;if("pointer"==a&&autosave.config[a][o].parent==t)return o}return token=autosave.generate(e),autosave.config[a][token]="pointer"==a?{parent:t,child:[]}:t,token},isExist:function(a){return null!=a&&void 0!=a},generate:function(a){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<3;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return null==a||void 0==a[t]?t:autosave.generate(a)},valid:function(a,t){if((a.attr("name")||a.attr("data-name"))&&("true"==a.attr("contentEditable")||"input"==t||"checkbox"==t||"radio"==t||"textarea"==t||"select"==t))return!0},getvaluelist:function(a,t){var e=autosave.config.pointer[t].child,o="";if(0==e.length)return $("."+t).val();for(var n=0;n<e.length;n++)e[n].attr("data-name")!=a&&e[n].attr("name")!=a||e[n].is(":checked")&&(o+=e[n].val()+"&");return o.length>0&&(o=o.substring(0,o.length-1)),o},getByGroup:function(a,t,e,o){for(var n=o.replace(/\s/g,"").split(","),r=autosave.config.pointer[t].child,i=0;i<r.length;i++)for(var c=0;c<n.length;c++)if(r[i].attr("data-name")==n[c]||r[i].attr("name")==n[c]){var a=n[c],u=r[i],v=u.prop("tagName").toLowerCase(),s=u.attr("type"),f=autosave.getInfo(u,v).value;"checkbox"!=s&&"radio"!=s||(f=autosave.getvaluelist(a,t)),e[a]=f}return e},setfalse:function(a,t){var e=autosave.config.pointer[t].child;if(0!=e.length)for(var o=0;o<e.length;o++)if(e[o].attr("data-name")==a||e[o].attr("name")==a){var n=JSON.parse(e[o].attr("data-cache"));n.value=!1,n=JSON.stringify(n),e[o].attr("data-cache",n)}},retry:function(a,t){var e=JSON.parse(a.attr("data-cache"));autosave.save(t,e,!0)},save:function(a,t,e){var o=t.name,n=a.attr("data-group"),r=a.attr("type"),i=a.prop("tagName").toLowerCase(),c=autosave.getInfo(a,i),u=t.pointer;if(c.value!==t.value||e){var v=c.value,s=autosave.config.action[t.action],f={},l={},g={before:autosave.config.before,success:autosave.config.success,fail:autosave.config.fail};if("checkbox"!=r&&"radio"!=r||(v=autosave.getvaluelist(o,u)),f[o]=v,void 0!=n&&(f=autosave.getByGroup(o,u,f,n)),l.action=s,l.data=f,l.target=a,void 0==t.before||1==g.before[t.before](l)){t.value=c.value,cache=JSON.stringify(t);var e=function(t){t.html('Your changes could not be saved. <a href="#">Try again</a>');var e=t.find("a");e.attr("data-cache",cache),e.on("click",function(t){t.preventDefault(),autosave.retry($(this),a)})};l.before=t.value,l.retry=e,$.ajax({method:"POST",url:s,data:f}).done(function(e){"radio"==r&&autosave.setfalse(o,u),void 0!=t.success&&g.success[t.success](e,l),a.attr("data-cache",cache)}).fail(function(){void 0!=t.fail&&g.fail[t.fail](l)})}}}};!function(a){a.fn.autosave=function(t){for(var e=a(this),t=void 0==typeof t?{}:t,o=0;o<e.length;o++)autosave.load(e[o],t)}}(jQuery);